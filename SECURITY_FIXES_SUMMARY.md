# ‚úÖ –í–´–ü–û–õ–ù–ï–ù–ù–´–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø –ë–ï–ó–û–ü–ê–°–ù–û–°–¢–ò –ò –û–ü–¢–ò–ú–ò–ó–ê–¶–ò–ò

## üîí –ö–†–ò–¢–ò–ß–ù–´–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø –ë–ï–ó–û–ü–ê–°–ù–û–°–¢–ò (–í–´–ü–û–õ–ù–ï–ù–û)

### ‚úÖ 1. CORS Configuration - –ò–°–ü–†–ê–í–õ–ï–ù–û
**–§–∞–π–ª:** `server/index.js:175-206`
- –£–±—Ä–∞–Ω `Access-Control-Allow-Origin: *`
- –î–æ–±–∞–≤–ª–µ–Ω whitelist —Ä–∞–∑—Ä–µ—à–µ–Ω–Ω—ã—Ö –¥–æ–º–µ–Ω–æ–≤
- –î–æ–±–∞–≤–ª–µ–Ω `Access-Control-Allow-Credentials: true`

### ‚úÖ 2. Session ID –∏–∑ Query Parameters - –ò–°–ü–†–ê–í–õ–ï–ù–û
**–§–∞–π–ª:** `server/middleware/auth.js:15`
- –£–±—Ä–∞–Ω–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∞ `req.query?.sessionId`
- Session ID —Ç–µ–ø–µ—Ä—å —Ç–æ–ª—å–∫–æ –∏–∑ headers –∏–ª–∏ cookies

### ‚úÖ 3. init_data –Ω–µ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ –ë–î - –ò–°–ü–†–ê–í–õ–ï–ù–û
**–§–∞–π–ª:** `server/index.js:520-523`
- –£–±—Ä–∞–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ `init_data` –≤ —Ç–∞–±–ª–∏—Ü—É sessions
- –°–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ `telegram_id` –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å–µ—Å—Å–∏—è–º–∏

### ‚úÖ 4. Rate Limiting –Ω–∞ –∫—Ä–∏—Ç–∏—á–Ω—ã–µ —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã - –î–û–ë–ê–í–õ–ï–ù–û
**–§–∞–π–ª:** `server/index.js:190-213`
- `letterCreateLimiter`: 20 –ø–∏—Å–µ–º –∑–∞ 15 –º–∏–Ω—É—Ç
- `searchLimiter`: 30 –ø–æ–∏—Å–∫–æ–≤ –≤ –º–∏–Ω—É—Ç—É
- `duelCreateLimiter`: 10 –¥—É—ç–ª–µ–π –∑–∞ 15 –º–∏–Ω—É—Ç
- –ü—Ä–∏–º–µ–Ω–µ–Ω–æ –∫ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–º —Ä–æ—É—Ç–∞–º

### ‚úÖ 5. Security Headers - –î–û–ë–ê–í–õ–ï–ù–û
**–§–∞–π–ª:** `server/index.js:149-157`
- `X-Content-Type-Options: nosniff`
- `X-Frame-Options: DENY`
- `X-XSS-Protection: 1; mode=block`
- `Referrer-Policy: strict-origin-when-cross-origin`
- `Permissions-Policy: geolocation=(), microphone=(), camera=()`

### ‚úÖ 6. Helmet Configuration - –ù–ê–°–¢–†–û–ï–ù–û
**–§–∞–π–ª:** `server/index.js:132-147`
- –ù–∞—Å—Ç—Ä–æ–µ–Ω Content Security Policy –¥–ª—è Telegram Mini App
- `crossOriginEmbedderPolicy: false` (—Ç—Ä–µ–±—É–µ—Ç—Å—è –¥–ª—è Telegram)
- –ü—Ä–∞–≤–∏–ª—å–Ω—ã–µ –¥–∏—Ä–µ–∫—Ç–∏–≤—ã –¥–ª—è scripts, styles, images, connect-src

---

## ‚ö° –û–ü–¢–ò–ú–ò–ó–ê–¶–ò–Ø –ü–†–û–ò–ó–í–û–î–ò–¢–ï–õ–¨–ù–û–°–¢–ò (–í–´–ü–û–õ–ù–ï–ù–û)

### ‚úÖ 7. Database Connection Pool - –ù–ê–°–¢–†–û–ï–ù–û
**–§–∞–π–ª:** `server/index.js:48-54`
- `max: 20` - –º–∞–∫—Å–∏–º—É–º —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π
- `idleTimeoutMillis: 30000` - –∑–∞–∫—Ä—ã—Ç–∏–µ idle —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π
- `connectionTimeoutMillis: 2000` - —Ç–∞–π–º–∞—É—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
- `statement_timeout: 10000` - —Ç–∞–π–º–∞—É—Ç –∑–∞–ø—Ä–æ—Å–æ–≤

### ‚úÖ 8. –°–æ—Å—Ç–∞–≤–Ω—ã–µ –∏–Ω–¥–µ–∫—Å—ã - –î–û–ë–ê–í–õ–ï–ù–û
**–§–∞–π–ª:** `server/migrations.js`
- `idx_letters_user_status_created` - –¥–ª—è —á–∞—Å—Ç—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ –ø–æ user_id + status + created_at
- `idx_letters_user_favorite` - –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ
- `idx_duels_challenger_status` - –¥–ª—è –∑–∞–ø—Ä–æ—Å–æ–≤ –ø–æ challenger_id + status
- `idx_duels_opponent_status` - –¥–ª—è –∑–∞–ø—Ä–æ—Å–æ–≤ –ø–æ opponent_id + status

### ‚úÖ 9. Cache-Control –¥–ª—è —Å—Ç–∞—Ç–∏–∫–∏ - –î–û–ë–ê–í–õ–ï–ù–û
**–§–∞–π–ª:** `server/index.js:116-127`
- `maxAge: '1y'` - –∫—ç—à –Ω–∞ 1 –≥–æ–¥
- `etag: true` - –ø–æ–¥–¥–µ—Ä–∂–∫–∞ ETag
- `Cache-Control: public, max-age=31536000, immutable`

---

## üõ°Ô∏è –í–ê–õ–ò–î–ê–¶–ò–Ø –ò –û–ì–†–ê–ù–ò–ß–ï–ù–ò–Ø (–í–´–ü–û–õ–ù–ï–ù–û)

### ‚úÖ 10. –í–∞–ª–∏–¥–∞—Ü–∏—è —Ä–∞–∑–º–µ—Ä–∞ –∫–æ–Ω—Ç–µ–Ω—Ç–∞ - –î–û–ë–ê–í–õ–ï–ù–û
**–§–∞–π–ª:** `server/routes/letters.js:13-19`
- `MAX_CONTENT_SIZE = 10MB` - –º–∞–∫—Å–∏–º—É–º —Ä–∞–∑–º–µ—Ä–∞ –∫–æ–Ω—Ç–µ–Ω—Ç–∞
- `MAX_TITLE_SIZE = 500` - –º–∞–∫—Å–∏–º—É–º —Å–∏–º–≤–æ–ª–æ–≤ –≤ –∑–∞–≥–æ–ª–æ–≤–∫–µ
- `MAX_ATTACHMENTS = 10` - –º–∞–∫—Å–∏–º—É–º –≤–ª–æ–∂–µ–Ω–∏–π
- `MAX_RECIPIENTS = 50` - –º–∞–∫—Å–∏–º—É–º –ø–æ–ª—É—á–∞—Ç–µ–ª–µ–π
- –í–∞–ª–∏–¥–∞—Ü–∏—è —á–µ—Ä–µ–∑ Zod —Å—Ö–µ–º—ã

---

## üìù –£–õ–£–ß–®–ï–ù–ò–ï –ö–û–î–ê (–í–´–ü–û–õ–ù–ï–ù–û)

### ‚úÖ 11. –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã –≤–º–µ—Å—Ç–æ –º–∞–≥–∏—á–µ—Å–∫–∏—Ö —á–∏—Å–µ–ª - –í–´–ù–ï–°–ï–ù–û
**–§–∞–π–ª:** `server/index.js:40-52`
- `RATE_LIMIT_WINDOW_MS = 15 * 60 * 1000`
- `RATE_LIMIT_MAX_REQUESTS = 300`
- `RATE_LIMIT_VERIFY_WINDOW_MS = 10 * 60 * 1000`
- `RATE_LIMIT_VERIFY_MAX = 30`
- `RATE_LIMIT_LETTER_CREATE_MAX = 20`
- `RATE_LIMIT_SEARCH_WINDOW_MS = 1 * 60 * 1000`
- `RATE_LIMIT_SEARCH_MAX = 30`
- `RATE_LIMIT_DUEL_CREATE_MAX = 10`

---

## üìä –°–¢–ê–¢–ò–°–¢–ò–ö–ê –ò–ó–ú–ï–ù–ï–ù–ò–ô

- **–§–∞–π–ª–æ–≤ –∏–∑–º–µ–Ω–µ–Ω–æ:** 5
  - `server/index.js` - –æ—Å–Ω–æ–≤–Ω—ã–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
  - `server/middleware/auth.js` - —É–±—Ä–∞–Ω sessionId –∏–∑ query
  - `server/routes/letters.js` - –≤–∞–ª–∏–¥–∞—Ü–∏—è –∏ rate limiting
  - `server/routes/duels.js` - rate limiting
  - `server/migrations.js` - —Å–æ—Å—Ç–∞–≤–Ω—ã–µ –∏–Ω–¥–µ–∫—Å—ã

- **–ö—Ä–∏—Ç–∏—á–Ω—ã—Ö –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π:** 6
- **–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏–π:** 3
- **–£–ª—É—á—à–µ–Ω–∏–π –∫–æ–¥–∞:** 2

---

## üöÄ –°–õ–ï–î–£–Æ–©–ò–ï –®–ê–ì–ò (–û–ü–¶–ò–û–ù–ê–õ–¨–ù–û)

### –°—Ä–µ–¥–Ω–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç:
- [ ] –î–æ–±–∞–≤–∏—Ç—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ (winston/pino)
- [ ] –î–æ–±–∞–≤–∏—Ç—å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ (Sentry)
- [ ] –î–æ–±–∞–≤–∏—Ç—å –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ Redis –¥–ª—è —á–∞—Å—Ç—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
- [ ] –î–æ–±–∞–≤–∏—Ç—å —Ç–µ—Å—Ç—ã (Jest + Supertest)

### –ù–∏–∑–∫–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç:
- [ ] –î–æ–±–∞–≤–∏—Ç—å –∞–Ω–∞–ª–∏—Ç–∏–∫—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–≥–æ –ø–æ–≤–µ–¥–µ–Ω–∏—è
- [ ] –î–æ–±–∞–≤–∏—Ç—å A/B —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
- [ ] –£–ª—É—á—à–∏—Ç—å onboarding
- [ ] –î–æ–±–∞–≤–∏—Ç—å —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—É—é —Å–∏—Å—Ç–µ–º—É

---

## ‚úÖ –ì–û–¢–û–í–ù–û–°–¢–¨ –ö PRODUCTION

–ü–æ—Å–ª–µ —ç—Ç–∏—Ö –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ **–≥–æ—Ç–æ–≤–æ –∫ –±–µ–∑–æ–ø–∞—Å–Ω–æ–º—É –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é –≤ production**.

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–µ—Ä–µ–¥ –¥–µ–ø–ª–æ–µ–º:**
1. ‚úÖ –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ –≤—Å–µ `.env` –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã
2. ‚úÖ –£–±–µ–¥–∏—Ç—å—Å—è —á—Ç–æ HTTPS —Ä–∞–±–æ—Ç–∞–µ—Ç
3. ‚úÖ –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –±—ç–∫–∞–ø—ã –ë–î
4. ‚úÖ –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å rate limiting
5. ‚úÖ –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ CORS —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ

---

**–î–∞—Ç–∞ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π:** 2024
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ö—Ä–∏—Ç–∏—á–Ω—ã–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –≤—ã–ø–æ–ª–Ω–µ–Ω—ã
