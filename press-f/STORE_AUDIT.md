# Аудит страницы «Магазин» (Store)

**Дата:** 16.02.2025  
**Цель:** логика запросов, оптимизация нагрузки на сервер, стабильная витрина.

---

## 1. Проблемы (до правок)

### 1.1 Лишний запрос каталога при наличии кэша

- **Было:** При валидном кэше (`applyCatalogFromCache() === true`) витрина показывалась из кэша, но `doFetch` всё равно вызывался с задержкой 0 ms → запрос `GET /api/store/catalog` выполнялся при каждом открытии магазина.
- **Итог:** 429 «Слишком много запросов» при частых заходах в магазин или при нескольких пользователях.

### 1.2 Четыре запроса при открытии магазина

- **Было:** Одновременно или с небольшой разницей по времени:
  1. `storeAPI.getCatalog()` (сразу или через 2 с);
  2. Через 5 с: `starsAPI.getPremiumStatus()`, `profileAPI.get()`, `storeAPI.getMyItems()` — три запроса параллельно.
- **Итог:** Пиковая нагрузка на сервер и риск упираться в лимиты (429).

### 1.3 getPremiumStatus вызывался всегда

- Баланс Stars нужен в основном на вкладке «Stars». Запрос `getPremiumStatus` при первом открытии магазина (вкладка XP) был избыточен.

### 1.4 Аватары грузились все сразу

- В категории «Аватары» для каждого товара рендерился `<img src="...">` без отложенной загрузки.
- При раскрытии категории все изображения запрашивались одновременно → много запросов к `/api/static/avatars/...` и риск 429 или долгой отрисовки.

### 1.5 Короткая пауза при 429

- При ответе 429 повторный запрос планировался через 6 с. При жёстком лимите на сервере этого могло не хватать → снова 429.

---

## 2. Внесённые изменения

### 2.1 Кэш каталога: без запроса при валидном кэше

- Если есть валидный кэш (не старше 10 мин), запрос `getCatalog` **не** выполняется при открытии магазина.
- Сразу показывается витрина из кэша и вызываются только `profileAPI.get` + `storeAPI.getMyItems` (баланс XP и «мои предметы»).
- Фоновое обновление каталога один раз через **45 с** (`BACKGROUND_REVALIDATE_MS`), чтобы кэш по возможности обновлялся без лишних запросов при каждом заходе.

### 2.2 Меньше и «размазанные» запросы при первом открытии

- **Без кэша:** один запрос `getCatalog`; после его успешного ответа — два запроса параллельно: `profileAPI.get` и `storeAPI.getMyItems`. Итого 1 + 2 вместо 1 + 3 и без лишнего «взрыва» через 5 с.
- **С кэшем:** 0 запросов каталога, только 2 запроса: `profileAPI.get` и `storeAPI.getMyItems`.
- **getPremiumStatus:** вызывается только при переходе на вкладку «Stars» (вместе с каталогом Stars или отдельно при кэше Stars). На вкладках XP / TON / Моё баланс Stars не запрашивается.

### 2.3 Вкладка Stars

- Каталог Stars по-прежнему грузится только при открытии вкладки «Stars» (с задержкой 2 с).
- При первом открытии вкладки Stars: один раз запрашиваются каталог Stars и премиум-статус (два запроса).
- При 429 для Stars пауза перед повтором увеличена (см. ниже).

### 2.4 Ленивая загрузка аватаров

- Для карточек аватаров в витрине у `<img>` добавлены `loading="lazy"` и `decoding="async"`.
- Изображения подгружаются по мере появления в зоне видимости, а не все сразу при раскрытии категории.

### 2.5 Увеличенная пауза при 429

- Константа `RATE_LIMIT_RETRY_SEC = 18` (секунд).
- При ответе 429 (каталог XP или Stars) повтор запроса выполняется не через 6 с, а через 18 с, чтобы снизить вероятность повторного 429.

---

## 3. Текущая логика запросов (после правок)

| Действие                         | Запросы |
|----------------------------------|--------|
| Открытие магазина, есть кэш      | 0 каталог + 2 (profile, my-items). Через 45 с — 1 фоновый getCatalog. |
| Открытие магазина, нет кэша     | 1 getCatalog, затем 2 (profile, my-items). |
| Переход на вкладку «Stars»      | 2 (Stars catalog + premium-status) с задержкой 2 с, или 1 (premium-status) при кэше Stars. |
| Раскрытие категории «Аватары»   | Только запросы картинок по мере появления в viewport (lazy). |

---

## 4. Рекомендации на будущее

- **Сервер:** при возможности увеличить лимит запросов в единицу времени для `/api/store/catalog` и `/api/static/avatars` или ввести отдельные лимиты для статики.
- **Клиент:** при появлении других тяжёлых списков (например, много превью) тоже использовать `loading="lazy"` и по необходимости виртуализацию списка.
- **Кэш Stars:** при частых 429 на вкладке Stars можно увеличить TTL кэша Stars (сейчас 10 мин) или показывать только кэшированный каталог до истечения паузы 429.
