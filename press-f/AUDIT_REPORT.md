# Отчёт аудита приложения PRESS F

**Дата:** 16.02.2025  
**Роль:** Senior Developer + Senior QA (доскональная проверка)  
**Область:** Фронтенд (press-f), маршрутизация, API-клиент, контексты, экраны, утилиты.

---

## 1. Критические и высокие проблемы

### 1.1 Двойная навигация при старте без deep link (App.tsx)

**Где:** `App.tsx`, два `useEffect` с зависимостями `[]`.

**Суть:** При открытии приложения без `start_param` оба эффекта выполняются:
- первый: `setTimeout(() => navigate('/', { replace: true }), 0)`;
- второй: при `currentPath !== '/'` снова вызывается `navigate('/', { replace: true })`.

**Риск:** Двойной вызов `navigate`, лишние рендеры, возможный мерцание при открытии по прямой ссылке (например, `#/profile`).

**Рекомендация:** Оставить один источник истины: либо только первый эффект с `setTimeout`, либо только второй. Убрать дублирование.

---

### 1.2 Реферальный deep link `ref_` не обрабатывается на фронте

**Где:** `App.tsx` — обрабатываются только `witness_`, `duel_`, `squad_`.

**Суть:** Ссылки вида `?start=ref_XXXX` обрабатываются на бэкенде (при верификации/сессии), но на фронте нет явного перехода или сохранения контекста. Если бэкенд ожидает, что фронт что-то сделает с `ref_` (например, показать экран «Вас пригласили»), этого нет.

**Рекомендация:** Уточнить у бэкенда, нужен ли на фронте отдельный экран/логика для `ref_`. Если да — добавить ветку `else if (startParam.startsWith('ref_'))` и навигацию/сохранение в storage.

---

### 1.3 Класс `glitch-text` не определён (Resurrection)

**Где:** `Resurrection.tsx`, строка ~60: `className="... glitch-text ..."`.

**Суть:** В проекте ни в `index.css`, ни в Tailwind нет определения `.glitch-text`. Класс висит без стилей/анимации — визуального глитч-эффекта нет.

**Рекомендация:** Либо завести в `index.css` класс `.glitch-text` с анимацией (например, лёгкий skew/translate/hue-rotate), либо убрать класс из разметки.

---

### 1.4 Ошибка поиска не сбрасывает результаты (Search)

**Где:** `Search.tsx`, `useEffect` по `query`.

**Суть:** При запросе по поиску: при успехе выставляются `letters` и `duels` из ответа; при ошибке или отсутствии `result.data` старые значения не сбрасываются. Пользователь может видеть устаревшие результаты после сбоя API.

**Рекомендация:** В ветке, где `!result.ok` или нет данных, вызывать `setLetters([])` и `setDuels([])`.

---

## 2. Средние проблемы

### 2.1 Логи в прод-коде (App, index, API)

**Где:**  
- `App.tsx`: `console.log('[App] Initializing...', ...)`, `console.log('[App] Start param:', ...)` и др.  
- `index.tsx`: несколько `console.log` при инициализации.  
- `utils/api.ts`: `console.log('[API] API_BASE:', ...)` в dev, но при отсутствии `VITE_API_URL` лог может идти и в проде.

**Суть:** Лишний шум в консоли, потенциальная утечка информации (origin, pathname, start_param).

**Рекомендация:** Обернуть логи в проверку `import.meta.env.DEV` или убрать; в проде оставить только `console.error` для критичных ошибок. В vite.config уже есть комментарий про удаление console — убедиться, что он реально включён для production-сборки.

---

### 2.2 ErrorBoundary и экран ошибки только на английском

**Где:** `ErrorBoundary.tsx` — текст "Something went wrong", "The application encountered an error...", "Reload Page".

**Суть:** Нет использования `useTranslation` / `t()`, язык интерфейса при падении всегда английский.

**Рекомендация:** Подключить `LanguageContext` в fallback UI (или передать `t` через props) и выводить строки через `t('error_boundary_title')`, `t('error_boundary_message')`, `t('reload_page')` и добавить ключи в `translations.ts` (en/ru).

---

### 2.3 Resurrection: часть текста не переведена

**Где:** `Resurrection.tsx` — строки "SYSTEM FAILURE", "USER_HEARTBEAT_LOST", "Protocol 66 initiated...", "T-MINUS 00:00:00", "> SYSTEM_REBOOT_INITIATED..." и т.д.

**Суть:** Используются хардкодные английские фразы вместо ключей перевода.

**Рекомендация:** Вынести строки в `translations.ts` (en/ru) и заменить на `t('resurrection_system_failure')`, `t('resurrection_heartbeat_lost')` и т.д.

---

### 2.4 Дублирование маршрута для главной

**Где:** `App.tsx`, `AnimatedLayoutRoutes`:  
`<Route index element={<Landing />} />` и `<Route path="/" element={<Landing />} />`.

**Суть:** Один и тот же экран зарегистрирован дважды. Работает корректно, но избыточно.

**Рекомендация:** Оставить один вариант (достаточно `path="/"` или `index`).

---

### 2.5 ApiErrorContext: возможная потеря retry-колбэка

**Где:** `ApiErrorContext.tsx`:  
`setOnRetry(retry ? () => retry : null)`.

**Суть:** Если вызывать `showApiError(msg, someRetry)` несколько раз подряд, предыдущий `someRetry` замыкается в новую функцию. Поведение в целом ожидаемое, но при быстрых повторных вызовах можно теоретически вызвать устаревший retry. На практике маловероятно.

**Рекомендация:** Оставить как есть; при желании можно хранить последний `retry` в ref и вызывать его по кнопке, чтобы всегда вызывался актуальный.

---

## 3. Низкие / улучшения

### 3.1 useDeadManSwitch и актуальность настроек

**Где:** `useDeadManSwitch.ts` — раз в минуту вызывается `checkStatus()`, который читает `storage.getSettings()`.

**Суть:** Если пользователь меняет интервал (например, в настройках) и не перезаходит на экран с таймером, обновление может отобразиться с задержкой до 1 минуты. Критичным не является.

**Рекомендация:** При изменении настроек в Settings можно вызывать событие/колбэк или инвалидировать состояние (например, через контекст), чтобы таймер обновился без ожидания интервала.

---

### 3.2 Store: catalogError при сбое — "Network error"

**Где:** `Store.tsx`, в catch при загрузке каталога: `setCatalogError('Network error')`.

**Суть:** Всегда одна и та же строка; не используется `t()` и не показывается сообщение от API (например, 500 с текстом ошибки).

**Рекомендация:** Использовать `t('api_error_network')` или показывать `res.error` при наличии, с fallback на общую фразу.

---

### 3.3 Много экранов не показывают глобальный API-баннер

**Где:** Landing (чек-ин), Store, Profile, CreateLetter, Notifications, Squads, WitnessApproval и др.

**Суть:** Глобальный `showApiError` используется в Duels и Letters. Остальные экраны показывают ошибки через `tg.showPopup`, локальный state или только `console.error`. Это непоследовательно, но не баг.

**Рекомендация:** Унифицировать: для критичных действий (чек-ин, отправка письма, покупка) либо везде использовать баннер с Retry, либо явно документировать, где и почему используется только popup.

---

## 4. Что сделано хорошо

- **Роутинг:** HashRouter, разделение на маршруты с Layout и без (Resurrection), lazy-загрузка экранов.
- **API:** Повтор запросов с экспоненциальной задержкой, таймаут 30 с, поддержка AbortSignal, корректная обработка 429 и AbortError в Store.
- **Store:** Кэш каталога и Stars, проверки `mountedRef`, отмена таймеров при размонтировании, коллапс категорий после исправления порядка инициализации.
- **Локализация:** Богатый `translations.ts` (en/ru), ключи для ошибок API, настроек, вики.
- **Доступность:** Учёт `prefers-reduced-motion`, `aria-label` на кнопках, `role="alert"` у баннера ошибок.
- **Безопасность:** Верификация initData (useTelegramSession), шифрование писем (security.ts), санитизация (sanitize.ts).

---

## 5. Чек-лист по контенту и сценариям

| Область | Статус | Замечание |
|--------|--------|-----------|
| Главная (чек-ин, таймер, настройка интервала) | OK | Круг с черепом вращается (skull-ring-rotate), PRESS F со свечением/глитчем. |
| Письма (список, создание, черновик, отправка) | OK | Подтверждение выхода, MainButton SEND, автосохранение черновика. |
| Дуэли (список, создание, фильтры) | OK | showApiError при ошибке загрузки, подтверждение выхода при открытой форме. |
| Магазин (XP, Stars, TON, My) | OK | Кэш, 429 и повтор, коллапс категорий, нет бесконечных запросов. |
| Профиль, настройки, вики | OK | TON, язык, тема, changelog. |
| Поиск | Средне | При ошибке API не сбрасываются старые результаты (см. 1.4). |
| Resurrection | Средне | Текст не переведён, класс glitch-text не определён (см. 1.3, 2.3). |
| Witness, Squads, Share, Notifications | OK | Ошибки логируются, есть обработка. |
| Deep links (witness_, duel_, squad_) | OK | ref_ на фронте не обрабатывается (см. 1.2). |

---

## 6. Итоговые рекомендации (приоритет)

1. **Исправить:** двойную навигацию в `App.tsx` (один эффект для редиректа без start_param).  
2. **Добавить:** определение `.glitch-text` в CSS или убрать класс в Resurrection.  
3. **Исправить:** в Search при ошибке/пустом ответе сбрасывать `letters` и `duels`.  
4. **Решить:** нужна ли обработка `ref_` на фронте; при необходимости добавить.  
5. **Уменьшить логи в проде:** обернуть/удалить console.log в App, index, api (оставить только в dev или убрать).  
6. **Локализовать:** ErrorBoundary и экран Resurrection (все тексты через `t()`).  
7. **Убрать дублирование:** один маршрут для главной (удалить либо `index`, либо `path="/"`).

После внесения пунктов 1–4 и при желании 5–7 приложение будет в хорошем состоянии с точки зрения стабильности, предсказуемости навигации и полноты контента/локализации.

---

## 7. Выполненные исправления (актуально)

- **App.tsx:** единый эффект для deep link и редиректа, обработка `ref_`, логи только в DEV, try-catch для localStorage.
- **index.css:** класс `.glitch-text` и анимация для Resurrection.
- **Search.tsx:** сброс `letters`/`duels` при ошибке и в catch; useApiAbort, isMountedRef, requestId для race condition.
- **ErrorBoundary:** используется ErrorFallback с `t()` (error_boundary_title, reload_page и т.д.).
- **Resurrection:** все строки через `t('resurrection_*')`.
- **Маршруты:** один маршрут для главной (`path="/"`), без дублирования index.
- **ApiErrorContext:** retry хранится в ref, по кнопке вызывается актуальный retry.
- **Store:** сообщения об ошибках через `t('api_error_network')`.
- **Settings:** isMounted для запросов getCatalog/getMyItems/getPremiumStatus.
- **StreakIndicator, StreakCalendar, ReferralSection, DailyQuests:** isMounted/isMountedRef, чтобы не вызывать setState после unmount.
